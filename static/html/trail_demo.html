<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <style>
    html,
    body {
      margin: 0px;
      padding: 0px
    }

  </style>
  <script src="/static/three/three.min.js"></script>
  <script src="/static/three/SVGLoader.js"></script>
  <script src="/static/three/OrbitControls.js"></script>
  <script src="/static/three/tween.js"></script>
  <script src="/static/three/trail_data_up.js"></script>
  <script src="/static/three/util.js"></script>
</head>

<body>
  <div id="WebGL-output"></div>
  <div style="position: absolute; top: 10px; left: 10px">
    <a href="javascript:;" onclick="createPath('',0)" style="color: #ffffff" id="play">
      <img src="/static/img/play_animate.png" width="26" alt="..">
    </a>
  </div>
  <script>
    // var data = TRAIL_JSON_LOOP.data;
    var data;
    var renderer, scene, camera, group;
    var maskGroup;
    var elevatorGroup;
    var space = 240;
    var planeList = [];
    var geometryArr = [];
    var materialArr = [];
    var offset_x = -290; // x中心点偏移量
    var offset_z = -241; // z中心点偏移量
    var duration = 1000; // 动画片段持续时间
    var pic_width = 0; // 图片宽度
    var pic_height = 0; // 图片高度
    var sceneCube = 2.5; // 场景立方体系数
    var opacity = 0
    var mockFloorData = [{
        imgURL: 1,
        floorName: 'F10'
      },
      {
        imgURL: 2,
        floorName: 'F11'
      },
      {
        imgURL: 3,
        floorName: 'F12'
      },
      {
        imgURL: 4,
        floorName: 'F13'
      }
    ]

    var targetRotation = 0;
    var arrows = []; // 路径点集合
    var arrowsLength = 35; // 路径点数量
    var t = 0.0; // 路径遍历点
    var s = 0.005; // 移动速度
    var path; // 目标路径导线
    
    var isElevator = false;
    var currentElevator = [];
    var currentPathPointIndex = 0;

    // 动画参数板
    var TRANSFER_BOARD = {
      HALFROTATE: 0.5 * Math.PI,
      ARROWROTATE: 0.5 * Math.PI,
      ORIGIN_NONE_X: 0, // 隐藏楼层的初始偏转角
      ORIGIN_PLAY_X: 0.08 * Math.PI, // 显示楼层的初始偏转角
      ORIGIN_Y: 0 * Math.PI, // 隐藏楼层和显示楼层的共同初始Y偏转角
      ROTATE_X: 0 * Math.PI, // 过渡偏转角
      ROTATE_Y: -0.1 * Math.PI, // 过渡偏转角
      HIGH_POS: 190, // 最高点
      PASS_HIGH_POS: 120, // 过渡点
      MIDDLE_POS: 0, // 显示区
      PASS_LOW_POS: -60, // 过渡点
      LOW_POS: -210, // 最低点
      OPACITY_BLOCK: 1, // 完全显示
      OPACITY_NONE: 0 // 完全隐藏
    }

    var LAST_FLOOR;
    var BEGIN_FLOOR;
    var END_FLOOR;
    // 获取当前url
    var url = parent.document.getElementById("threeFrame").contentWindow.location.href

    // 调色板
    var PALLETTE = {
      LIGHT: '#FFFFFF', // 灯光
      STORE: '#4E98F2', // 商店
      EDGE: '#1A3050', // 描边
      PLANE: '#1C1A23', // 底座
      PATH: '#FFE000', // 路径
      CIRCLE: '#FFE000', // 抓拍点
      CIRCLE_START: '#7ED321', // 起始点
      CIRCLE_END: '#FF0000', // 结束点
      ELEVATOR: '#FFE000' // 电梯点
    }

    var play = false;
    var play_count = parseInt(parent.document.getElementById("threeFrame").contentWindow.location.search.split('&')[0].split('=')[1])
    var play_current = 0;

    function getTrailData(trailData) {
      data = trailData
      // data = TRAIL_JSON_UP.data;
    }

    var communityInfo = []

    function receiveCommunityInfo(data) {
      communityInfo = data
      init()
    }

    // 动画trigger
    function changefloor(currentElevator, index, targetFloorName, type) {
      setTimeout(function () {
        ChapterTwo(type) // duration: 2s
      }, 1000)
      // setTimeout(function () {
        // animateMiddleFloor(BEGIN_FLOOR, END_FLOOR) // duration: 4s
      // }, 2000)
      // setTimeout(function () {
        // ChapterThree('up') // duration: 2s
      // }, 6000)
      if (targetFloorName) {
        ChapterOneOffCoast()
      }
      if (currentElevator) {
        setTimeout(function () {
          TrailPath(currentElevator, type)
        }, 3000)
      }
      if (index) {
        setTimeout(function () {
          createPath(targetFloorName, index)
        }, 6000)
      }
    }

    

    function setPlayStatus() {
      if (play) {
        document.getElementById('play').removeAttribute('onclick')
      } else {
        document.getElementById('play').setAttribute('onclick', 'createPath("",0)')
      }
    }

    function init() {
      // 布置场景
      createScene() // 创建场景
      createCamera() // 创建相机
      createRenderer() // 创建渲染器
      createLight() // 创建灯光
      createGeneralGroup() // 创建整体分组
      createListener() // 创建监听函数

      // 创建楼层
      // console.log(communityInfo)
      communityInfo.forEach(function (item) {
        createFloor(item)
      })

      // 布置调度
      // createAlexHelper()
      createControl()

      // 开始动画
      ChapterZero()
      ChapterOne()

      if (getQueryString()) {
        replay()
      }

      // 开始渲染
      render()
    }

    loadSignal()

    function replay() {
      setTimeout(function () {
        createPath('', 0)
      }, 1000)
    }

    function loadSignal() {
      window.parent.postMessage({
        cmd: 'trail-load_signal',
        params: {}
      }, '*');
    }

    // 确定轨迹开始的楼层
    function ChapterZero() {
      BEGIN_FLOOR = data[0].floorName
    }

    // step1: 放置所有起始楼层的最初位置
    function ChapterOne() {
      group.children.forEach(function (item) {
        if (item.name === BEGIN_FLOOR) {
          item.position.set(0, 0, 0)
          item.rotation.x = TRANSFER_BOARD.ORIGIN_PLAY_X
          item.rotation.y = TRANSFER_BOARD.ORIGIN_Y
        } else if (structFloorInfo(BEGIN_FLOOR, item.name)) {
          item.position.y = TRANSFER_BOARD.HIGH_POS
          item.rotation.x = TRANSFER_BOARD.ORIGIN_NONE_X
          item.rotation.y = TRANSFER_BOARD.ORIGIN_Y
        } else if (!structFloorInfo(BEGIN_FLOOR, item.name)) {
          item.position.y = TRANSFER_BOARD.LOW_POS
          item.rotation.x = TRANSFER_BOARD.ORIGIN_NONE_X
          item.rotation.y = TRANSFER_BOARD.ORIGIN_Y
        }
      })
    }

    function ChapterOneOffCoast() {
      group.children.forEach(function (item) {
        if(item.name !== BEGIN_FLOOR && item.name !== LAST_FLOOR){
          if (structFloorInfo(BEGIN_FLOOR, item.name)) {
            item.position.y = TRANSFER_BOARD.HIGH_POS
            item.rotation.x = TRANSFER_BOARD.ORIGIN_NONE_X
            item.rotation.y = TRANSFER_BOARD.ORIGIN_Y
          } else if (!structFloorInfo(BEGIN_FLOOR, item.name)) {
            item.position.y = TRANSFER_BOARD.LOW_POS
            item.rotation.x = TRANSFER_BOARD.ORIGIN_NONE_X
            item.rotation.y = TRANSFER_BOARD.ORIGIN_Y
          }
        }
      })
    }

    // step2: 电梯楼层动画
    function ChapterTwo(type) {
      if(elevatorGroup.children.length) {
        elevatorGroup.children.forEach(function(item){
          elevatorGroup.remove(item)
        })
        elevatorGroup.children = []
      }
      group.children.forEach(function (item) {
        animateLowerElevator(item, type === 'up' ? BEGIN_FLOOR : END_FLOOR, type)
        animateHigerElevator(item, type === 'up' ? END_FLOOR : BEGIN_FLOOR, type)
      })
    }

    // step3: 切换楼层动画
    function ChapterThree(type) {
      group.children.forEach(function (item) {
        animateLowerFloor(item, type === 'up' ? BEGIN_FLOOR : END_FLOOR, type)
        animateHigerFloor(item, type === 'up' ? END_FLOOR : BEGIN_FLOOR, type)
      })
    }

    // step4: 回到所有楼层
    function ChapterFour() {
      camera = new THREE.OrthographicCamera(
        window.innerWidth / -2,
        window.innerWidth / 2,
        window.innerHeight / 2,
        window.innerHeight / -2,
        0.1, 10000
      )
      camera.position.set(330, 180, 450)
      camera.lookAt(0, 0, 0)
      camera.updateProjectionMatrix()
      createControl()
      group.children.forEach(function (item, index) {
        var position_start = {
          y: item.position.y
        }
        var position_end = {
          y: -220 + index * 140
        }
        var rotate_start = {
          x: item.rotation.x,
          y: item.rotation.y,
          z: item.rotation.z
        }
        var rotate_end = {
          x: 0,
          y: 0,
          z: 0
        }
        var opactiy_start = {
          opacity: 0
        }
        var opacity_end = {
          opacity: 1
        }
        var opacity_back_start = {
          opacity: 1
        }
        var opacity_back_end = {
          opacity: 0
        }
        item.children.forEach(function (val) {
          // if (val.name !== 'elevator') {
          val.material.opacity = 1
          // }
        })

        var action1 = new TWEEN.Tween(position_start)
          .to(position_end, duration)
          .onUpdate(function () {
            item.position.y = position_start.y;
            // action3.start()
          })
        var action2 = new TWEEN.Tween(rotate_start)
          .to(rotate_end, duration)
          .onUpdate(function () {
            item.rotation.x = rotate_start.x;
            item.rotation.y = rotate_start.y;
            item.rotation.z = rotate_start.z;
            // action3.start()
          })
        // var action3 = new TWEEN.Tween(opactiy_start)
        //   .to(opacity_end, duration)
        //   .onUpdate(function(){
        //     // action1.start()
        //     item.children.forEach(function (val) {
        //       if (val.name !== 'elevator') {
        //         val.material.opacity = opactiy_start.opacity
        //         // item.position.y = -220 + index * 140
        //         // item.rotation.set(0,0,0)
        //       }
        //     })
        //   })
        // var action4 = new TWEEN.Tween(opacity_back_start)
        //   .to(opacity_back_end, duration)
        //   .onUpdate(function(){
        //     item.children.forEach(function (val) {
        //       if (val.name !== 'elevator') {
        //         val.material.opacity = opacity_back_start.opacity
        //       }
        //     })
        //   })
        action1.chain(action2)
        action1.start()
      })
    }

    // 电梯动画片段: 低层变化过程
    function animateLowerElevator(item, floorName, type) {
      if (item.name === floorName && END_FLOOR !== LAST_FLOOR) {
        var lowPositionStart = {
          x: item.position.x,
          y: item.position.y
        }
        var lowPositionEnd = {
          x: item.position.x,
          y: TRANSFER_BOARD.PASS_LOW_POS
        }
        var lowRotationStart = {
          x: item.rotation.x,
          y: item.rotation.y
        }
        var lowRotationEnd = {
          x: TRANSFER_BOARD.ROTATE_X,
          y: TRANSFER_BOARD.ROTATE_Y
        }
        var lowOpacityStart = {
          opacity: type === 'up' ? TRANSFER_BOARD.OPACITY_BLOCK : TRANSFER_BOARD.OPACITY_NONE
        }
        var lowOpacityEnd = {
          opacity: TRANSFER_BOARD.OPACITY_BLOCK
        }
        var lowAction1 = new TWEEN.Tween(lowPositionStart)
          .to(lowPositionEnd, duration)
          .onUpdate(function () {
            item.position.x = lowPositionStart.x;
            item.position.y = lowPositionStart.y;
          })
        var lowAction2 = new TWEEN.Tween(lowRotationStart)
          .to(lowRotationEnd, duration)
          .onUpdate(function () {
            item.rotation.x = lowRotationStart.x
            item.rotation.y = lowRotationStart.y
            lowAction3.start()
          })
        var lowAction3 = new TWEEN.Tween(lowOpacityStart)
          .to(lowOpacityEnd, duration)
          .onUpdate(function () {
            item.children.forEach(function (val) {
              if (val.name !== 'elevator') {
                val.material.opacity = lowOpacityStart.opacity
              }
            })
          })
        lowAction2.chain(lowAction1)
        lowAction2.start()
      } else if(item.name !== floorName && item.name !== BEGIN_FLOOR && END_FLOOR !== LAST_FLOOR){
        var lowOpacityStartO = {
          opacity: item.children[0].material.opacity
        }
        var lowOpacityEndO = {
          opacity: TRANSFER_BOARD.OPACITY_NONE
        }
        var lowAction4 = new TWEEN.Tween(lowOpacityStartO)
          .to(lowOpacityEndO, duration)
          .onUpdate(function () {
            item.children.forEach(function (val) {
              if (val.name !== 'elevator') {
                val.material.opacity = lowOpacityStartO.opacity
              }
            })
          })
        lowAction4.start()
      }
    }

    // 电梯动画片段: 高层变化过程
    function animateHigerElevator(item, floorName, type) {
      if (item.name === floorName && END_FLOOR !== LAST_FLOOR) {
        var highPositionStart = {
          x: item.position.x,
          y: item.position.y
        }
        var highPositionEnd = {
          x: item.position.x,
          y: TRANSFER_BOARD.PASS_HIGH_POS
        }
        var highRotationStart = {
          x: item.rotation.x,
          y: item.rotation.y
        }
        var highRotationEnd = {
          x: TRANSFER_BOARD.ROTATE_X,
          y: TRANSFER_BOARD.ROTATE_Y
        }
        var highOpacityStart = {
          opacity: type === 'up' ? item.children[0].material.opacity : TRANSFER_BOARD.OPACITY_BLOCK
        }
        var highOpacityEnd = {
          opacity: TRANSFER_BOARD.OPACITY_BLOCK
        }
        var highAction1 = new TWEEN.Tween(highPositionStart)
          .to(highPositionEnd, duration)
          .onUpdate(function () {
            item.position.x = highPositionStart.x;
            item.position.y = highPositionStart.y;
          })
        var highAction2 = new TWEEN.Tween(highRotationStart)
          .to(highRotationEnd, duration)
          .onUpdate(function () {
            item.rotation.x = highRotationStart.x
            item.rotation.y = highRotationStart.y
            highAction3.start()
          })
        var highAction3 = new TWEEN.Tween(highOpacityStart)
          .to(highOpacityEnd, duration)
          .onUpdate(function () {
            item.children.forEach(function (val) {
              if (val.name !== 'elevator') {
                val.material.opacity = highOpacityStart.opacity
              }
            })
          })
        highAction2.chain(highAction1)
        highAction2.start()
      } else if(item.name !== floorName && item.name !== BEGIN_FLOOR && END_FLOOR !== LAST_FLOOR) {
        var highOpacityStartO = {
          opacity: item.children[0].material.opacity
        }
        var highOpacityEndO = {
          opacity: TRANSFER_BOARD.OPACITY_NONE
        }
        var highAction4 = new TWEEN.Tween(highOpacityStartO)
          .to(highOpacityEndO, duration)
          .onUpdate(function () {
            item.children.forEach(function (val) {
              if (val.name !== 'elevator') {
                val.material.opacity = highOpacityStartO.opacity
              }
            })
          })
        highAction4.start()
      }
    }

    // 楼层动画片段: 低层变化过程
    function animateLowerFloor(item, floorName, type) {
      if (item.name === floorName) {
        var lowPositionStart = {
          x: item.position.x,
          y: item.position.y
        }
        var lowPositionEnd = {
          x: item.position.x,
          y: type === 'up' ? TRANSFER_BOARD.LOW_POS : TRANSFER_BOARD.MIDDLE_POS
        }
        var lowRotationStart = {
          x: item.rotation.x,
          y: item.rotation.y
        }
        var lowRotationEnd = {
          x: type === 'up' ? TRANSFER_BOARD.ORIGIN_NONE_X : TRANSFER_BOARD.ORIGIN_PLAY_X,
          y: TRANSFER_BOARD.ORIGIN_Y
        }
        var lowOpacityStart = {
          opacity: TRANSFER_BOARD.OPACITY_BLOCK
        }
        var lowOpacityEnd = {
          opacity: type === 'up' ? item.children[0].material.opacity : TRANSFER_BOARD.OPACITY_BLOCK
        }
        var lowAction1 = new TWEEN.Tween(lowPositionStart)
          .to(lowPositionEnd, duration)
          .onUpdate(function () {
            item.position.x = lowPositionStart.x;
            item.position.y = lowPositionStart.y;
          })
        var lowAction2 = new TWEEN.Tween(lowRotationStart)
          .to(lowRotationEnd, duration)
          .onUpdate(function () {
            item.rotation.x = lowRotationStart.x
            item.rotation.y = lowRotationStart.y
            lowAction3.start()
          })
        var lowAction3 = new TWEEN.Tween(lowOpacityStart)
          .to(lowOpacityEnd, duration)
          .onUpdate(function () {
            item.children.forEach(function (val) {
              if (val.name !== 'elevator') {
                val.material.opacity = lowOpacityStart.opacity
              }
            })
          })
        lowAction2.chain(lowAction1)
        lowAction2.start()
      }
    }

    // 楼层动画片段: 高层变化过程
    function animateHigerFloor(item, floorName, type) {
      if (item.name === floorName) {
        var highPositionStart = {
          x: item.position.x,
          y: item.position.y
        }
        var highPositionEnd = {
          x: item.position.x,
          y: type === 'up' ? TRANSFER_BOARD.MIDDLE_POS : TRANSFER_BOARD.HIGH_POS
        }
        var highRotationStart = {
          x: item.rotation.x,
          y: item.rotation.y
        }
        var highRotationEnd = {
          x: type === 'up' ? TRANSFER_BOARD.ORIGIN_PLAY_X : TRANSFER_BOARD.ORIGIN_NONE_X,
          y: TRANSFER_BOARD.ORIGIN_Y
        }
        var highOpacityStart = {
          opacity: TRANSFER_BOARD.OPACITY_BLOCK
        }
        var highOpacityEnd = {
          opacity: type === 'up' ? TRANSFER_BOARD.OPACITY_BLOCK : TRANSFER_BOARD.OPACITY_NONE
        }
        var highAction1 = new TWEEN.Tween(highPositionStart)
          .to(highPositionEnd, duration)
          .onUpdate(function () {
            item.position.x = highPositionStart.x;
            item.position.y = highPositionStart.y;
          })
        var highAction2 = new TWEEN.Tween(highRotationStart)
          .to(highRotationEnd, duration)
          .onUpdate(function () {
            item.rotation.x = highRotationStart.x
            item.rotation.y = highRotationStart.y
            highAction3.start()
          })
        var highAction3 = new TWEEN.Tween(highOpacityStart)
          .to(highOpacityEnd, duration)
          .onUpdate(function () {
            item.children.forEach(function (val) {
              if (val.name !== 'elevator') {
                val.material.opacity = highOpacityStart.opacity
              }
            })
          })
        highAction2.chain(highAction1)
        highAction2.start()
      }
    }

    // 动画片段：中间楼层的显示和隐藏
    function animateMiddleFloor(BEGIN_FLOOR, END_FLOOR) {
      var calcRes = calcFloor(BEGIN_FLOOR, END_FLOOR)
      var floorArr = calcFloorArray(BEGIN_FLOOR, END_FLOOR)
      var loader = new THREE.SVGLoader();
      var middlePosition = (TRANSFER_BOARD.PASS_HIGH_POS + TRANSFER_BOARD.PASS_LOW_POS) / 2
      var middleIndex = parseInt(floorArr.length / 2)
      if (calcRes > 0) {
        for (var i = 0; i < floorArr.length - 1; i++) {
          var curPosition
          if (i === middleIndex) {
            curPosition = middlePosition
          } else {
            curPosition = middlePosition + (i - middleIndex) * 10
          }
          var middlePlane = new MiddlePlane();
          middlePlane.mesh.position.y = curPosition
          loader.load('/static/origin-floor/bottom.svg', function (paths) {
            var middleText = new TextSprite(floorArr[i])
            middleText.textObj.position.y = curPosition
            maskGroup.add(middleText.textObj)
          })
          maskGroup.add(middlePlane.mesh)
        }
      }

      var opacityStart = {
        opacity: 0.2
      }
      var opacityEnd = {
        opacity: 0
      }
      var opacityStart2 = {
        opacity: 0.2
      }
      var opacityEnd2 = {
        opacity: 0
      }

      var action1 = new TWEEN.Tween(opacityEnd)
        .to(opacityStart, duration)
        .onUpdate(function () {
          maskGroup.children.forEach(function (val) {
            val.material.opacity = opacityEnd.opacity
          })
        })

      var action2 = new TWEEN.Tween(opacityStart2)
        .to(opacityEnd2, duration)
        .onUpdate(function () {
          maskGroup.children.forEach(function (val) {
            val.material.opacity = opacityStart2.opacity
          })
        }).delay(3000)

      action1.chain(action2)
      action1.start()
    }

    function createGeneralGroup() {
      group = new THREE.Group();
      group.name = 'all_scene'
      maskGroup = new THREE.Group()
      group.name = 'mask_scene'
      elevatorGroup = new THREE.Object3D();
      elevatorGroup.name = 'elevator'
      scene.add(group)
      scene.add(maskGroup)
    }

    function createFloor(item) {
      var floorGroup = new THREE.Group();
      var loader = new THREE.SVGLoader();
      var textLoader = new THREE.FontLoader();

      loader.load(item.mapUrl, function (paths) {
        for (var i = 0; i < paths.length; i++) {
          var shapes = paths[i].toShapes(true)

          for (var j = 0; j < shapes.length; j++) {

            // if (i === 0) continue

            var shape = shapes[j]
            var points = shape.getPoints()
            shape.autoClose = true

            var store = new Store(shape, item.name)
            store.mesh.updateMatrix();
            floorGroup.add(store.mesh)

            var edge = new Edge(points, item.name)
            edge.mesh.updateMatrix()
            floorGroup.add(edge.mesh)
          }
        }
      })

      loader.load('/static/origin-floor/bottom.svg', function (paths) {
        for (var i = 0; i < paths.length; i++) {
          var shapes = paths[i].toShapes(true)
          for (var j = 0; j < shapes.length; j++) {
            var shape = shapes[j];

            var plane = new Plane(shape, item.name)
            plane.mesh.updateMatrix()
            floorGroup.add(plane.mesh);

            var text = new TextSprite(item.name)
            floorGroup.add(text.textObj)
          }
        }
      })

      textLoader.load('/static/three/FZLanTingHei_Regular.json', function (res) {
        var font = res;
        floorGroup.children.forEach(function(floor) {
          if (floor.name === 'store') {
            var meshAlex = getString(floor.userData.coordinates)
            for (var j in item.subGroupSon){
              if(meshAlex === item.subGroupSon[j].coordinates){
                var point = getCenterExtraPoint(floor.userData.coordinates)
                var ipc = {
                  text: item.subGroupSon[j].name,
                  position: {x: point.cx, y: point.cy}
                }
                var textStore = new Text(ipc, font, item.name)
                floorGroup.add(textStore.text)
              }
            } 
          }
        })
      })

      floorGroup.name = item.name
      group.add(floorGroup)
    }

    var capturePoint_count = 0

    function createPath(floorName, currentPathPointIndex) {
      if (!floorName) {
        floorName = BEGIN_FLOOR
      }

      if (status > 0) {
        refresh()
        return
      }

      var count = currentPathPointIndex
      var count_child = 0
      var capturePoint_color = PALLETTE.CIRCLE
      var floorGroup;
      var trailBall = new TrailBall()
      var positionY = 9
      play = true;
      setPlayStatus()

      group.children.forEach(function (item) {
        if (item.name === floorName) {
          floorGroup = item
          floorGroup.add(trailBall.mesh)
        }
      })

      var timer1 = setInterval(function () {

        // 绘制路径
        if (count <= data.length - 2) {
          var pathGroup = {
            start: { x: data[count].point.x, y: -data[count].point.y },
            end: { x: data[count + 1].point.x, y: -data[count + 1].point.y }
          }

          var path = new Path(pathGroup)
          path.line.position.y = positionY
          path.line.rotation.x = 0.5 * Math.PI
          floorGroup.add(path.line)
          // 绘制轨迹球
          var action1 = new TWEEN.Tween(pathGroup.start)
            .to(pathGroup.end, 30)
            .onUpdate(function () {
              trailBall.mesh.position.x = pathGroup.start.x;
              trailBall.mesh.position.y = positionY
              trailBall.mesh.position.z = pathGroup.start.y - 25;
            })
          action1.start()
        }

        // 绘制抓拍点
        if (data[count].capturePoint) {
          if (capturePoint_count === 0) {
            capturePoint_color = PALLETTE.CIRCLE_START
          } else if (capturePoint_count > 0 && !data[count + 1]) {
            capturePoint_color = PALLETTE.CIRCLE_END
          } else {
            capturePoint_color = PALLETTE.CIRCLE
          }
          let obj = new THREE.Vector3(
            data[count].point.x - pic_width / 2,
            positionY,
            -data[count].point.y - pic_height / 2
          )
          let circle = new Circle(obj, capturePoint_color)
          circle.mesh.rotation.x = -0.5 * Math.PI
          floorGroup.add(circle.mesh)
          capturePoint_count++
        }

        count += 1

        if (count === data.length) {
          clearInterval(timer1)
          play = false;
          status++;
          setPlayStatus()
          if(elevatorGroup.children.length) {
            elevatorGroup.children.forEach(function(item){
              elevatorGroup.remove(item)
            })
            elevatorGroup.children = []
          }
          setTimeout(function () {
            ChapterFour()
          }, 1000)
        }

        if (count > currentPathPointIndex + 2 && data[count - 1].elevator === true) {
          currentElevator[0] = data[count - 1]
          currentElevator[1] = data[count]
          LAST_FLOOR = BEGIN_FLOOR
          BEGIN_FLOOR = data[count - 3].floorName
          END_FLOOR = data[count + 1].floorName
          var delay = setTimeout(function () {
            floorGroup.remove(trailBall.mesh)
            clearTimeout(delay)
          }, 3000)

          if (structFloorInfo(BEGIN_FLOOR, END_FLOOR)) {
            changefloor(currentElevator, count, END_FLOOR, 'up')
          } else {
            changefloor(currentElevator, count, END_FLOOR, 'down')
          }
          clearInterval(timer1)
        }

      }, 10)
    }

    
    // 电梯轨迹
    function TrailPath(currentElevator, type) {

      var position = {
        x: currentElevator[0].point.x - pic_width / 2 + 15,
        y: -currentElevator[0].point.y - pic_height / 2 - 25,
        x1: currentElevator[1].point.x - pic_width / 2 + 15,
        y1: -currentElevator[1].point.y - pic_height / 2 - 25
      }

      var pathGroup = {
        start: {
          x: position.x,
          y: type === 'up' ? TRANSFER_BOARD.PASS_LOW_POS : TRANSFER_BOARD.PASS_HIGH_POS,
          z: position.y
        },
        end: {
          x: position.x1,
          y: type === 'up' ? TRANSFER_BOARD.PASS_HIGH_POS : TRANSFER_BOARD.PASS_LOW_POS,
          z: position.y1
        }
      }

      var timeDuration = pathGroup.end.y - pathGroup.start.y + 9
      var timeUnit = 0

      // 画人
      var people = new TrailBall();
      people.mesh.position.set(pathGroup.start.x, pathGroup.start.y, pathGroup.start.z)
      elevatorGroup.add(people.mesh)

      scene.add(elevatorGroup);

      var timer2 = setInterval(function () {
        var cubeGeometry = new THREE.BoxGeometry(1,1,1)
        var cubeMaterial = new THREE.MeshBasicMaterial({
          color: PALLETTE.PATH,
          side: THREE.DoubleSide
        })
        var cubeMesh = new THREE.Mesh(cubeGeometry, cubeMaterial)
        cubeMesh.position.set(pathGroup.start.x, pathGroup.start.y + timeUnit, pathGroup.start.z)
        people.mesh.position.y = pathGroup.start.y + timeUnit
        elevatorGroup.add(cubeMesh)
        if (timeUnit === timeDuration) {
          clearInterval(timer2)
          elevatorGroup.remove(people.mesh)
        }

        if (timeDuration > 0) {
          timeUnit ++
        } else {
          timeUnit --
        }
      }, 15)
    }

    /*****************************
     * ***************************
     * ********** 物体类 **********
     * ***************************
     * ***************************/

    // 单层楼色块
    function Store(shape, groupName) {
      var geometry2 = new THREE.ShapeBufferGeometry(shape)
      var geometryBuffer = new THREE.ExtrudeBufferGeometry(shape, {
        depth: 4,
        bevelEnabled: false
      })
      var geometry = new THREE.Geometry()
      geometry.fromBufferGeometry(geometryBuffer)

      var material = new THREE.MeshBasicMaterial({
        color: new THREE.Color(PALLETTE.STORE),
        transparent: true,
        depthWrite: false,
        opacity: groupName === BEGIN_FLOOR ? 1 : opacity,
        side: THREE.DoubleSide,
        // vertexColors: THREE.FaceColors
      })

      this.mesh = new THREE.Mesh(geometry, material)
      this.mesh.rotation.set(TRANSFER_BOARD.HALFROTATE, 0, 0)
      this.mesh.position.set(offset_x, 8, offset_z)
      this.mesh.name = 'store'
      this.mesh.userData.coordinates = geometry2.attributes.position.array
      this.mesh.geometry.faces.forEach(function (face) {
        // normal.y: 上下两面 normal.x: 左右两面 normal.z：前后两面
        if (face.normal.y !== 0 || face.normal.x !== 0) {
          // face.color = new THREE.Color('#2f89f8')
        }
      })
    }

    // 单层楼色块描边
    function Edge(points, groupName) {
      var geometry = new THREE.BufferGeometry().setFromPoints(points)
      var material = new THREE.LineBasicMaterial({
        color: PALLETTE.EDGE,
        transparent: true,
        depthWrite: false,
        opacity: groupName === BEGIN_FLOOR ? 1 : opacity
      })
      this.mesh = new THREE.Line(geometry, material)
      this.mesh.rotation.set(TRANSFER_BOARD.HALFROTATE, 0, 0)
      this.mesh.position.set(offset_x, 8, offset_z)
      this.mesh.name = 'edge'
    }

    // 单层楼底座
    function Plane(shape, groupName) {
      var geometry = new THREE.ShapeBufferGeometry(shape);
      var material = new THREE.MeshBasicMaterial({
        color: PALLETTE.PLANE,
        side: THREE.DoubleSide,
        depthWrite: true,
        transparent: true,
        opacity: groupName === BEGIN_FLOOR ? 1 : opacity
      })
      this.mesh = new THREE.Mesh(geometry, material);
      this.mesh.rotation.set(TRANSFER_BOARD.HALFROTATE, 0, 0)
      this.mesh.position.set(offset_x, 0, offset_z)
      this.mesh.name = 'plane'
    }

    // 中间楼层
    function MiddlePlane() {
      var geom = new THREE.PlaneGeometry(480, 340, 32)
      var material = new THREE.MeshBasicMaterial({
        transparent: true,
        depthWrite: false, // 处理opacity为0时在不同角度依然遮挡的问题
        side: THREE.DoubleSide,
        color: PALLETTE.PLANE,
        opacity: 0
      })
      this.mesh = new THREE.Mesh(geom, material)
      this.mesh.rotation.set(TRANSFER_BOARD.HALFROTATE + TRANSFER_BOARD.ROTATE_X, 0, -TRANSFER_BOARD.ROTATE_Y)
      this.mesh.name = 'middlePlane'
    }

    // 路径
    function Path(group) {
      var path = new THREE.Path([new THREE.Vector2(group.start.x - pic_width / 2, group.start.y - pic_height / 2 - 25)]);
      path.lineTo(group.end.x - pic_width / 2, group.end.y - pic_height / 2 - 25)
      var points = path.getPoints();
      var geometry = new THREE.BufferGeometry().setFromPoints(points)
      var material = new THREE.LineBasicMaterial({
        transparent: true,
        depthWrite: false,
        color: PALLETTE.PATH
      })
      this.line = new THREE.Line(geometry, material);
      this.line.name = 'path'
    }

    // 摄像头点
    function Circle(vector, color, rotate) {
      var geom = new THREE.CircleGeometry(5, 50)
      var material = new THREE.MeshBasicMaterial({
        transparent: true,
        depthWrite: false,
        color: color
      })
      this.mesh = new THREE.Mesh(geom, material);
      this.mesh.position.set(vector.x, vector.y, vector.z - 25)
      if (rotate) {
        this.mesh.rotation.x = rotate * Math.PI
      }
      this.mesh.name = 'circle'
    }

    // 楼层文字
    function TextSprite(text, position) {
      var canvas = document.createElement('canvas')
      var ctx = canvas.getContext('2d')
      var cz = camera.position.z // 摄像头z轴视距
      canvas.width = text.length * 200
      canvas.height = canvas.width / 4
      ctx.fillStyle = '#ffffff'
      ctx.font = '600 104px Microsoft YaHei Arial'
      ctx.textAlign = 'left'
      ctx.fillText(text, 0, 120)
      var texture = new THREE.Texture(canvas)
      texture.needsUpdate = true
      // 使用Sprite显示文字
      var material = new THREE.SpriteMaterial({
        map: texture,
        color: 0xffffff,
        depthWrite: false,
        transparent: true,
        opacity: text === BEGIN_FLOOR ? 1 : opacity
      })
      this.textObj = new THREE.Sprite(material)
      this.textObj.name = 'text'
      this.textObj.scale.set(cz * 0.047 * text.length, cz * 0.012 * text.length, 200)
      this.textObj.position.set(290, 0, 0)

    }

    // 商店文字
    function Text(obj, font, groupName) {
      var textGeometry = new THREE.TextGeometry(obj.text, {
        font: font,
        size: 7,
        height: 1
      })
      textGeometry.computeBoundingBox();
      var textWidth = textGeometry.boundingBox.max.x - textGeometry.boundingBox.min.x;
      var textHeight = textGeometry.boundingBox.max.y - textGeometry.boundingBox.min.y
      this.text = new THREE.Mesh(textGeometry, new THREE.MeshBasicMaterial({
          transparent: true,
          color: 0xffffff,
          opacity: groupName === BEGIN_FLOOR ? 1 : opacity,
          // flatShading: true,
          // depthWrite: false,
          // depthTest: false
          side: THREE.FrontSide
        }))
      this.text.name = 'store_text'
      this.text.rotation.x = -0.5 * Math.PI
      this.text.position.set(obj.position.x, 10, -obj.position.y)
    }

    // 贴图
    function PeopleSprite() {
      var texture = new THREE.TextureLoader().load('/static/img/people_sprite.png')
      texture.needsUpdate = true
      var spriteMaterial = new THREE.SpriteMaterial({
        map: texture,
        depthTest: false,
        blending: THREE.AdditiveBlending,
      })
      var sprite = new THREE.Sprite(spriteMaterial)
      sprite.scale.set(25, 25, 25)
      return sprite
    }

    // 轨迹球
    function TrailBall(){
      var geometry = new THREE.SphereGeometry(4,32,32)
      var material = new THREE.MeshBasicMaterial({
        color: PALLETTE.PATH,
        // depthTest: false,
        side: THREE.DoubleSide
      })
      this.mesh = new THREE.Mesh(geometry, material)
      this.mesh.name = 'trail_ball'
    }

    /****************************
     * **************************
     * ********** 布景 **********
     * **************************
     *****************************/

    // 场景
    function createScene() {
      scene = new THREE.Scene();
    }

    // 相机
    function createCamera() {
      // camera = new THREE.OrthographicCamera(
      //   window.innerWidth / -sceneCube,
      //   window.innerWidth / sceneCube,
      //   window.innerHeight / sceneCube,
      //   window.innerHeight / -sceneCube,
      //   0.1, 10000
      // )
      camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 10000)
      // camera.position.set(762, 399, 1170)
      camera.position.set(0, 250, 500)
      camera.lookAt(0, 0, 0);
      scene.add(camera)
    }

    // 灯光
    function createLight() {
      var light = new THREE.PointLight(PALLETTE.LIGHT, 0.8)
      camera.add(light)
    }

    // 渲染器
    function createRenderer() {
      renderer = new THREE.WebGLRenderer({
        antialias: true,
        alpha: true
      })
      renderer.setSize(window.innerWidth, window.innerHeight)
      document.getElementById("WebGL-output").appendChild(renderer.domElement)
    }

    // 监听器
    function createListener() {
      window.addEventListener('resize', onWindowResize, false)
    }

    // 控制函数
    function createControl() {
      controls = new THREE.OrbitControls(camera);
      // controls.maxPolarAngle = 1.28;//上下两极的可视区域的最大角度
      // controls.minPolarAngle = 1.28;//上下两极的可视区域最小角度
      // controls.dampingFactor = 0.25;
      controls.enableZoom = true;
      controls.enableRotate = true;
      controls.screenSpacePanning = true;
    }

    function createAlexHelper() {
      var axesHelper = new THREE.AxesHelper(100)
      scene.add(axesHelper)
    }

    // 渲染函数
    function render() {
      requestAnimationFrame(render)
      TWEEN.update()

      renderer.render(scene, camera)
    }

    function onWindowResize() {
      var innerWidth = window.innerWidth
      var innerHeight = window.innerHeight
      camera.aspect = innerWidth / innerHeight
      camera.updateProjectionMatrix()

      renderer.setSize(window.innerWidth, window.innerHeight)
    }

    /* **********************
     * ****** 其他方法 *******
     * **********************/

    // 数组转字符串
    var getString = function (arr) {
      return '['+Array.prototype.slice.call(arr).toString()+']'
    }

    // 刷新页面
    var refresh = function () {
      var url = parent.document.getElementById("threeFrame").contentWindow.location.href
      var host = url.split('?')[0]
      var params = '?playcount=' + (play_count+1) + '&status=1'
      window.location.href = host + params
    }

    // 获取中心点和右侧点
    var getCenterExtraPoint = function (array) {
      var a = changeArrayLevel(array)
      var ps = new Contour(a.buffer).centroid()
      return {
        cx: (ps.x - 290),
        cy: (214 - ps.y)
      }
    }

    // 获取playCount的值
    var getQueryString = function () {
      var r = url.split('?')[1]
      var s = r.split('&')[0]
      if (s) {
        var res = parseInt(s.split('=')[1])
        return res
      } else {
        return null
      }
    }

    // 0: 下楼 1: 上楼
    function structFloorInfo(startFloor, endFloor) {
      var s_floorAnti = startFloor.slice(0, 1)
      var s_floorNum = parseInt(startFloor.slice(1, startFloor.length))
      var e_floorAnti = endFloor.slice(0, 1)
      var e_floorNum = parseInt(endFloor.slice(1, endFloor.length))
      if (s_floorAnti === 'F' && e_floorAnti === 'B') return 0
      if (e_floorAnti === 'F' && s_floorAnti === 'B') return 1
      if (s_floorNum < e_floorNum) return 1
      if (s_floorNum > e_floorNum) return 0
    }

    // 计算楼层
    function calcFloor(startFloor, endFloor) {
      var s_floorNum = parseInt(startFloor.slice(1, startFloor.length))
      var e_floorNum = parseInt(endFloor.slice(1, endFloor.length))
      return Math.abs(s_floorNum - e_floorNum)
    }

    // 计算楼层数组
    function calcFloorArray(startFloor, endFloor) {
      var s_floorNum = parseInt(startFloor.slice(1, startFloor.length))
      var e_floorNum = parseInt(endFloor.slice(1, endFloor.length))
      var targetArr = []
      for (var i = 0; i < Math.abs(s_floorNum - e_floorNum); i++) {
        targetArr.push('F' + (parseInt(s_floorNum > e_floorNum ? e_floorNum : s_floorNum) + parseInt(i)))
      }
      return targetArr;
    }

  </script>
</body>

</html>
