<template>
    <div class="equipment__service--wrap">
      <uu-sub-tab
        search
        back
        @remote-search="search"
        placeholder="快速查找设备"
        :menu-array="menu">
      </uu-sub-tab>
      <div class="filter__list--wrap">
        <el-select clearable v-model="filterValue.type" placeholder="全部类型">
          <el-option :value="4" label="客行分析"></el-option>
          <el-option :value="5" label="人脸抓拍"></el-option>
        </el-select>
        <el-select clearable v-model="filterValue.groupGuid" placeholder="绑定社群">
          <el-option :value="null" label="未绑定"></el-option>
          <el-option
            v-for="(item, $index) in bindGroups"
            :key="$index"
            :value="item.groupGuid"
            :label="item.name"></el-option>
        </el-select>
        <el-menu @select="handleSelect" mode="horizontal" class="device__menu">
          <el-submenu popper-class="device__menu--popper" index="1">
            <template slot="title">批量操作</template>
            <el-menu-item index="bind">绑定</el-menu-item>
            <el-menu-item index="unbind">解绑</el-menu-item>
            <el-menu-item index="delete">删除</el-menu-item>
          </el-submenu>
        </el-menu>
        <a href="javascript:void (0)" @click="clearFilters" class="fr">显示全部</a>
      </div>
      <el-scrollbar class="server__list-wrap">
        <el-table
          @selection-change="handleSelectionChange"
          border
          :data="tableList"
        >
          <el-table-column
            label="全部"
            width="55"
            align="center"
            type="selection">
          </el-table-column>
          <el-table-column
            label="名称"
            prop="name">
            <template slot-scope="scope">
              <span class="ellipsis-20">{{scope.row.name || '暂无'}}</span>
              <el-popover
                placement="top"
                popper-class="nick_name--popover"
                @show="showPopover(scope.$index)"
                @hide="hidePopover(scope.$index)"
                v-model="scope.row.popover"
                trigger="click">
                <el-form
                  :key="'tableForm' + scope.$index"
                  @submit.native.prevent
                  ref="tableForm"
                  :rules="rules"
                  class="table-form"
                  :model="equipmentForm"
                >
                  <el-form-item :key="scope.$index" prop="name">
                    <el-input type="text" v-model.trim="equipmentForm.name"></el-input>
                    <uu-icon type="success" @click.native="changeEquipmentName(scope.$index)"></uu-icon>
                    <uu-icon type="error" @click.native="scope.row.popover = false"></uu-icon>
                  </el-form-item>
                </el-form>
                <i slot="reference" v-if="scope.row.deviceType !== 1" class="el-icon-edit"></i>
              </el-popover>
            </template>
          </el-table-column>
          <el-table-column
            label="序列号"
            prop="deviceKey">
          </el-table-column>
          <el-table-column
            label="用途"
            prop="type">
            <template slot-scope="scope">
              {{scope.row.type | deviceType}}
            </template>
          </el-table-column>
          <el-table-column
            label="绑定社群"
            props="groupName">
            <template slot-scope="scope">
              <span class="ellipsis-28" :class="{'c-grey': !scope.row.groupName}">{{scope.row.groupName || '暂无'}}</span>
              <a href="javascript:void (0)" @click="showDialogForm(scope.row)" :class="{danger: scope.row.groupName}">{{scope.row.groupName ? '解绑': '绑定'}}</a>
            </template>
          </el-table-column>
          <el-table-column
            v-if="$route.name === 'equipmentMineService'"
            width="150"
            label="操作">
            <template slot-scope="scope">
              <a href="javascript:void (0)" class="g-mr15" @click="showEditForm(scope.row)">编辑</a>
              <a href="javascript:void (0)" class="danger" @click="deleteEquipment(scope.row)">删除</a>
            </template>
          </el-table-column>
        </el-table>
        <el-pagination
          class="mt10"
          v-if="pagination.total && pagination.total>pagination.length"
          @current-change="getDeviceList"
          :current-page="pagination.index"
          :page-size="pagination.length"
          layout="total,prev, pager, next, jumper"
          :total="pagination.total">
        </el-pagination>
      </el-scrollbar>
      <!--绑定社群-->
      <ob-dialog-form
        filter
        @remote-submit="bindCommunity"
        :group="groupList"
        title="绑定社群"
        type="group"
        :visible.sync="dialogFormVisible"
      >
      </ob-dialog-form>
      <!--编辑摄像头信息-->
      <ob-dialog-form
        :show-button="false"
        title="编辑信息"
        :visible.sync="editCameraVisible">
        <el-form
          slot="form"
          ref="editCameraForm"
          block-message
          style="width: 330px"
          label-position="left"
          class="common-form white"
          label-width="82px"
          :model="editCameraForm"
          :rules="editCameraRules"
        >
          <el-form-item class="mt10" label="名称：" prop="name">
            <el-input placeholder="请输入设备名称" v-model="editCameraForm.name"></el-input>
          </el-form-item>
          <el-form-item class="mt24" label="类型：" prop="type">
            <el-select v-model="editCameraForm.type" placeholder="请选择设备类型">
              <el-option label="客行分析" :value="4"></el-option>
              <el-option label="人脸抓拍" :value="5"></el-option>
            </el-select>
          </el-form-item>
        </el-form>
        <div slot="footer" class="dialog-footer mt42">
          <el-button class="cancel" @click="editCameraVisible = false">返 回</el-button>
          <el-button class="affirm"  type="primary" @click="editCameraDevice('editCameraForm')">确定</el-button>
        </div>
      </ob-dialog-form>
    </div>
</template>

<script>
import {simplifyGroups, restoreArray} from '../../utils'
import {validateRule} from '../../utils/validate'
import {mapState} from 'vuex'
export default {
  name: 'service',
  data () {
    const validateName = (rule, value, callback) => {
      console.log('validator', 'value')
      if (!value) {
        callback(new Error('请输入设备别名'))
      } else {
        if (value.length > 32) {
          callback(new Error('请输入1-32位字符'))
        } else if (validateRule(value, 2)) {
          this.$http('/merchant/device/alias/exist', {name: value}, false).then(res => {
            res.data ? callback(new Error('设备别名已存在')) : callback()
          }).catch(err => {
            callback(new Error(err.msg || '验证失败'))
          })
        } else {
          callback(new Error('请输入正确的设备别名'))
        }
      }
    }
    return {
      dialogFormVisible: false, // 绑定社群弹框
      multipleSelection: [],
      serviceList: [
      ],
      groupList: [],
      pagination: {},
      searchText: '',
      filterValue: {
        type: '',
        groupGuid: ''
      },
      bindCommunityForm: {},
      equipmentForm: {
        name: ''
      },
      rules: {
        name: [
          {required: true, validator: validateName, trigger: 'blur'}
        ]
      },
      editCameraVisible: false,
      editCameraForm: {
        name: '',
        type: ''
      },
      editCameraRules: {
        name: [
          {validator: validateName, trigger: 'blur'}
        ],
        type: [
          {required: true, message: '请选择设备类型', trigger: 'change'}
        ]
      }
    }
  },
  created () {
    this.getGroupList()
    this.getDeviceList()
  },
  mounted () {
  },
  computed: {
    ...mapState(['userInfo']),
    menu: {
      get () {
        let [text, name] = ['', this.$route.query.name]
        switch (this.$route.name) {
          case 'equipmentMineService':
            text = `自有设备&nbsp;&nbsp;&nbsp;&nbsp;/&nbsp;&nbsp;&nbsp;&nbsp;${name}`
            break
          case 'equipmentService':
            text = `非自有设备&nbsp;&nbsp;&nbsp;&nbsp;/&nbsp;&nbsp;&nbsp;&nbsp;${name}`
            break
        }
        return [{title: `${text}`}]
      },
      set () {}
    },
    bindList: {
      get () {
        let list = JSON.parse(JSON.stringify(this.groupList))
        return restoreArray(list, 'memberItem')
      },
      set () {}
    },
    bindGroups: {
      get () {
        let groups = JSON.parse(JSON.stringify(this.serviceList))
        let hash = {}
        groups = groups.map(item => {
          return {
            groupGuid: item.groupGuid,
            name: item.groupName
          }
        }).reduce((item2, next) => {
          if (next.groupGuid && !hash[next.groupGuid]) {
            hash[next.groupGuid] = true
            item2.push(next)
          }
          return item2
        }, [])
        return groups
      },
      set () {}
    },
    tableList: {
      get () {
        let newList = JSON.parse(JSON.stringify(this.serviceList))
        newList = newList.filter(item => {
          if (this.filterValue.type || this.filterValue.groupGuid !== '') {
            return (this.filterValue.type ? item.type === this.filterValue.type : true) && (this.filterValue.groupGuid !== '' ? item.groupGuid === this.filterValue.groupGuid : true)
          }
          return true
        })
        return newList
      },
      set (val) {
        this.serviceList = val
      }
    }
  },
  methods: {
    // 查询服务列表设备
    search (val) {
      this.searchText = val
      this.filterValue = {
        type: '',
        groupGuid: ''
      }
      this.getDeviceList()
    },
    // 清除过滤条件
    clearFilters () {
      this.filterValue = {
        groupGuid: '',
        type: ''
      }
    },
    // 获取摄像头设备列表信息
    getDeviceList (page) {
      page = page || this.pagination.index || 1
      let searchData = {
        serverKey: this.$route.params.key
      }
      if (this.searchText) searchData.name = this.searchText
      this.$http('/device/deviceCamera/search', searchData).then(res => {
        (res.data || []).map(item => {
          item.popover = false
          return item
        })
        this.serviceList = res.data || []
      })
    },
    // 获取社群树形结构数据
    getGroupList () {
      this.$http('/group/list/self').then(res => {
        this.groupList = simplifyGroups(res.data)
      })
    },
    // 多选框发生改变时触发，返回当前选中值
    handleSelectionChange (val) {
      this.multipleSelection = val
    },
    // 绑定社群
    bindCommunity (data) {
      let [subData, url] = ['', '/device/batch/binding']
      console.log('back', data)
      if (!data[0]) {
        this.$tip('请选取社群', 'error')
        return
      }
      if (!this.bindCommunityForm.deviceKey) {
        subData = JSON.parse(JSON.stringify(this.multipleSelection.filter(item => !item.groupName).map(item => {
          return {
            deviceKey: item.deviceKey,
            name: item.name,
            groupGuid: data[0].groupGuid,
            merchantGuid: this.userInfo.deverloperId
          }
        })))
      } else {
        subData = [{
          merchantGuid: this.userInfo.developerId,
          deviceKey: this.bindCommunityForm.deviceKey,
          groupGuid: data[0].groupGuid,
          name: this.bindCommunityForm.name
        }]
      }
      this.dialogFormVisible = false
      this.$load('设备绑定中...')
      this.$http(url, subData).then(res => {
        this.$load().close()
        this.$tip('绑定成功')
        this.getDeviceList()
      }).catch(() => {
        this.$load().close()
      })
    },
    // 解绑社群
    unBindCommunity (value, index) {
      this.$affirm({
        confirm: '确定',
        cancel: '返回',
        text: '确定将设备从社群解绑？'
      }, (action, instance, done) => {
        if (action === 'confirm') {
          this.$http('/device/unbinding', {
            deviceKey: value.deviceKey,
            groupGuid: value.groupGuid
          }).then(res => {
            this.$tip('解绑成功')
            this.getDeviceList()
          })
        }
        done()
      })
    },
    // 删除设备
    deleteEquipment (data) {
      let deleteArr = [data.deviceKey]
      if (Array.isArray(data)) {
        deleteArr = data.filter(item => !item.groupName).map(item => item.deviceKey)
        if (data.filter(item => item.groupName).length) {
          this.$tip('请先解绑设备', 'error')
          return
        }
      } else if (data.groupName) {
        this.$tip('请先解绑设备', 'error')
        return
      }
      this.$affirm(
        {
          confirm: '确定',
          cancel: '返回',
          text: `确定删除选中设备？`
        }, (action, instance, done) => {
          if (action === 'confirm') {
            this.$http('/device/deviceCamera/delete', deleteArr).then(res => {
              this.$tip('删除成功')
              this.getDeviceList()
            })
          }
          done()
        }
      )
    },
    // 批量操作处理
    handleSelect (type) {
      console.log(type, this.filterValue)
      if (!this.multipleSelection.length) {
        this.$tip('请选取设备', 'error')
        return
      }
      if (type === 'bind') {
        this.dialogFormVisible = true
      } else if (type === 'delete') {
        this.deleteEquipment(this.multipleSelection)
      } else {
        // 批量解绑
        // 数据提交是过滤掉未绑定社群的设备
        let selectArr = this.multipleSelection.filter(item => item.groupName).map(item => item.deviceKey)
        this.$affirm({
          confirm: '确定',
          cancel: '返回',
          text: '确定将设备从社群解绑？'
        }, (action, instance, done) => {
          if (action === 'confirm') {
            this.$http('/device/batch/unbinding', selectArr).then(res => {
              this.$tip('解绑成功')
              this.getDeviceList()
            })
          }
          done()
        })
      }
    },
    // 显示绑定社群弹框
    showDialogForm (row) {
      if (row.groupName) {
        this.unBindCommunity(row)
      } else {
        this.bindCommunityForm = row
        this.dialogFormVisible = true
      }
    },
    // 显示修改昵称popover
    showPopover (index) {
      if (this.$refs.tableForm) {
        this.$nextTick(() => {
          this.$refs.tableForm.clearValidate()
        })
      }
      this.equipmentForm = JSON.parse(JSON.stringify({
        deviceKey: this.serviceList[index].deviceKey,
        serverKey: this.serviceList[index].serverKey,
        name: this.serviceList[index].name
      }))
      console.log(index, this.equipmentForm)
    },
    // 隐藏修改昵称popover
    hidePopover (index) {
      // console.log(this.$refs.tableForm)
      // if (this.$refs.tableForm) {
      //   this.$refs.tableForm.clearValidate()
      // }
    },
    // 修改设备昵称
    changeEquipmentName (index) {
      this.$refs['tableForm'].validate((valid) => {
        if (valid) {
          this.$http('/device/deviceCamera/name/update', this.equipmentForm).then(res => {
            this.$tip('修改成功')
            this.$set(this.serviceList[index], 'popover', false)
            this.serviceList[index].name = this.equipmentForm.name
          }).catch(err => { console.log(err) })
        } else {
          console.log('error submit')
        }
      })
    },
    showEditForm (row) {
      this.editCameraForm = JSON.parse(JSON.stringify(row))
      this.editCameraVisible = true
    },
    // 编辑摄像头信息
    editCameraDevice (formName) {
      this.$refs[formName].validate(valid => {
        if (valid) {
          this.$http('/device/deviceCamera/info/add', this.editCameraForm).then(res => {
            this.$tip('修改成功')
            this.editCameraVisible = false
            this.getDeviceList()
          })
        }
      })
    }
  },
  watch: {
    dialogFormVisible (val) {
      if (val) {
        this.getGroupList()
      } else {
        this.bindCommunityForm = {}
      }
    },
    filterValue: {
      handler (val) {
        // this.getDeviceList()
      },
      deep: true
    }
  },
  filters: {
    cameraType (val) {
      let txt = ''
      switch (val) {
        case 1:
          txt = '客行分析'
          break
        case 2:
          txt = '人脸抓拍'
          break
      }
      return txt
    }
  }
}
</script>

<style lang="scss" scoped>
.filter__list--wrap{
  margin: 22px 0 12px;
  > .el-select {
    width: 150px;
    margin-right: 12px;
  }
  > .fr {
    margin-top: 8px;
    font-size: 12px;
  }
}
.server__list-wrap{
  height: calc(100% - 146px);
}
</style>
